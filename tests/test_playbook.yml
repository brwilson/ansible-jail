---
- hosts: 127.0.0.1
  become: true
  connection: local
  vars:
    rc_conf: '/etc/rc.conf.d/93842839-ansible-jail_rc.conf'
    jail_conf: '/usr/local/9304673409-ansible-jail_jail.conf'
  tasks:
    - block:
      - name: add new jail
        become: false
        jail: 
          name: 'testjail99'
          path: '/usr/local/jail/testjail99'
          ip4_addr: '192.168.1.232'
          interface: 'en0'
          conf_file: '{{ jail_conf }}'
          rc_file: '{{ rc_conf }}'
        ignore_errors: true
        register: new_noperms

      - name: check that jail creation failed due to permissions
        assert:
          that:
            - new_noperms.failed
            - new_noperms.msg == 'Unable to open /etc/rc.conf.d/93842839-ansible-jail_rc.conf for writing.'

      - name: set starting jail.conf contents
        copy:
          src: 'jail.conf.1'
          dest: '{{ jail_conf }}'

      always:
      - name: clean up files
        file:
          path: '{{ item }}'
          state: 'absent'
        with_items:
          - '{{ rc_conf }}'
          - '{{ jail_conf }}'
